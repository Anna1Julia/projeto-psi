{% extends "base.html" %}

{% block title %}{{ content.title }} - MemóriaViva{% endblock %}

{% block content %}
<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 style="color: white;">{{ content.title }}</h3>

                        {# ✅ Apenas o dono do conteúdo vê os botões Editar/Excluir #}
                        <div class="btn-group" role="group">
                            {% set can_admin_delete_content = (
                                current_user.is_authenticated
                                and current_user.is_administrador()
                                and not content.autor.is_administrador()
                            ) %}

                            {% if current_user.is_authenticated and (current_user.id == content.user_id or can_admin_delete_content) %}
                            <a href="{{ url_for('content.edit_content', content_id=content.id) }}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <button type="button" class="btn btn-danger" 
                                    onclick="if(confirm('Tem certeza que deseja excluir este conteúdo?')) document.getElementById('delete-form-{{ content.id }}').submit();">
                                <i class="fas fa-trash-alt"></i> Excluir
                            </button>
                            <form id="delete-form-{{ content.id }}" method="POST"
                                  action="{{ url_for('content.delete_content', content_id=content.id) }}" 
                                  style="display:none;">
                            </form>
                            {% endif %}
                            {% if current_user.is_authenticated %}
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="openReportModal('content', {{ content.id }})">
                                <i class="bi bi-flag"></i> Denunciar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            {% if content.url %}
                                <a href="{{ content.url }}" target="_blank" class="text-decoration-none">
                                    <div class="obra-thumbnail-container">
                                        {% if content.thumbnail %}
                                            <img src="{{ content.thumbnail }}" class="img-fluid" alt="{{ content.title }}">
                                        {% else %}
                                            <div class="bg-light w-100 d-flex align-items-center justify-content-center" style="height: 300px;">
                                                <i class="fas fa-book fa-5x text-muted"></i>
                                            </div>
                                        {% endif %}
                                        <div class="obra-thumbnail-overlay">
                                            <div class="obra-play-icon">
                                                <i class="fas fa-play"></i>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% else %}
                                {% if content.thumbnail %}
                                    <img src="{{ content.thumbnail }}" class="img-fluid rounded" alt="{{ content.title }}">
                                {% else %}
                                    <div class="bg-light w-100 d-flex align-items-center justify-content-center rounded" style="height: 300px;">
                                        <i class="fas fa-book fa-5x text-muted"></i>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>

                        <div class="col-md-8">
                            <div class="mb-3">
                                <span class="badge bg-primary fs-6">{{ content.type.title() }}</span>
                                {% if content.release_date %}
                                    <span class="badge bg-secondary fs-6">{{ content.release_date.year }}</span>
                                {% endif %}
                                {% if content.file_type %}
                                    <span class="badge bg-info fs-6">{{ content.file_type.upper() }}</span>
                                {% endif %}
                            </div>

                            {% if content.description %}
                                <h5>Descrição</h5>
                                <p>{{ content.description }}</p>
                            {% endif %}

                            {% if content.file_path %}
                                <div class="mt-4">
                                    <a href="{{ url_for('content.download_content', content_id=content.id) }}"
                                       class="btn btn-success btn-lg"
                                       data-no-loader="true">
                                        <i class="fas fa-download"></i> Baixar Arquivo
                                    </a>
                                </div>
                            {% endif %}

                            <div class="text-muted mt-3 d-flex gap-3 align-items-center">
                                <small>Adicionado em {{ content.created_at|format_datetime('%d/%m/%Y %H:%M') }}</small>
                                {% if content.views_count is not none %}
                                    <small><i class="bi bi-eye"></i> {{ content.views_count }} visualizações</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sistema de Avaliações e Comentários -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" style="color: white;">Avaliações e Comentários</h5>
                    {% if avg_rating %}
                        <div class="d-flex align-items-center">
                            <div class="rating-stars me-2">
                                {% for i in range(1, 6) %}
                                    {% if i <= avg_rating|int %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% elif i - 0.5 <= avg_rating %}
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                            <span class="text-muted ms-2">({{ total_ratings }} avaliações)</span>
                        </div>
                    {% endif %}
                </div>

                <div class="card-body ratings-comments-body">
                    {% if current_user.is_authenticated %}
                        <div class="mb-4 p-3 ratings-form-container rounded">
                            <h6 class="mb-3">Deixe sua avaliação</h6>
                            <form method="POST" action="{{ url_for('content.rate_content', content_id=content.id) }}">
                                <div class="mb-3">
                                    <label class="form-label">Sua nota:</label>
                                    <div class="rating-input">
                                        {% for i in range(5, 0, -1) %}
                                            <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}"
                                                {% if user_rating and user_rating.rating == i %}checked{% endif %} required>
                                            <label for="star{{ i }}"><i class="fas fa-star"></i></label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="review" class="form-label">Seu comentário (opcional):</label>
                                    <textarea class="form-control" id="review" name="review" rows="3"
                                              placeholder="Compartilhe sua opinião sobre este conteúdo...">{% if user_rating %}{{ user_rating.review or '' }}{% endif %}</textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                    {% if user_rating %}Atualizar Avaliação{% else %}Enviar Avaliação{% endif %}
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <a href="{{ url_for('auth.login') }}">Faça login</a> para avaliar e comentar este conteúdo.
                        </div>
                    {% endif %}

                    {% if ratings %}
                        <h6 class="mt-4 mb-3">Todas as avaliações:</h6>
                        {% for rating in ratings %}
                            <div class="rating-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ rating.usuario.nome }}</strong>
                                        <div class="rating-stars small">
                                            {% for i in range(1, 6) %}
                                                {% if i <= rating.rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">{{ rating.created_at|format_datetime("%d/%m/%Y às %H:%M") }}</small>
                                    </div>

                                    {% if current_user.is_authenticated and (current_user.id == rating.user_id or current_user.is_admin) %}
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="if(confirm('Deseja excluir esta avaliação?')) document.getElementById('delete-rating-{{ rating.id }}').submit();">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                        <form id="delete-rating-{{ rating.id }}" method="POST"
                                              action="{{ url_for('content.remove_rating', rating_id=rating.id) }}"
                                              style="display:none;">
                                        </form>
                                    {% endif %}
                                </div>
                                {% if rating.review %}
                                    <p class="mt-2 mb-0">{{ rating.review }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">Nenhuma avaliação ainda. Seja o primeiro a avaliar!</p>
                    {% endif %}
                </div>
            </div>

            <div class="mt-3">
                <a href="{{ url_for('content.list_content') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar ao Catálogo
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 5px;
}
.rating-input input[type="radio"] {
    display: none;
}
.rating-input label {
    cursor: pointer;
    font-size: 2rem;
    color: var(--color-muted, #9ca3af);
    transition: transform 0.15s ease, color 0.2s ease;
}
.rating-input label:hover,
.rating-input label:hover ~ label {
    color: #fbbf24;
    transform: translateY(-2px);
}
.rating-input input[type="radio"]:checked ~ label {
    color: #f59e0b;
}
:root.dark .rating-input label {
    color: #9ca3af;
}
:root.dark .rating-input label i {
    color: inherit;
    text-shadow: none !important;
    filter: none !important;
}
:root.dark .rating-input label:hover,
:root.dark .rating-input label:hover ~ label {
    color: #fbbf24;
    transform: translateY(-2px);
    text-shadow: none !important;
    filter: none !important;
}
:root.dark .rating-input label:hover i,
:root.dark .rating-input label:hover ~ label i {
    color: #fbbf24 !important;
    text-shadow: none !important;
    filter: none !important;
}
:root.dark .rating-input input[type="radio"]:checked ~ label {
    color: #f59e0b;
    text-shadow: none !important;
    filter: none !important;
}
:root.dark .rating-input input[type="radio"]:checked ~ label i {
    color: #f59e0b !important;
    text-shadow: none !important;
    filter: none !important;
}

.rating-stars i {
    font-size: 1.2rem;
}
/* Estrelas no dark mode - amarelas sólidas iguais ao tema claro, sem brilho */
:root.dark .rating-stars i.fa-star:not(.far),
:root.dark .rating-stars i.fa-star-half-alt,
:root.dark .rating-stars .text-warning.fa-star:not(.far),
:root.dark .rating-stars .text-warning.fa-star-half-alt,
:root.dark .rating-stars i.text-warning.fa-star:not(.far),
:root.dark .rating-stars i.text-warning.fa-star-half-alt,
:root.dark .rating-stars .fas.fa-star,
:root.dark .rating-stars .fas.fa-star-half-alt {
    color: #fbbf24 !important;
    text-shadow: none !important;
    filter: none !important;
    box-shadow: none !important;
}
:root.dark .rating-stars i.far.fa-star,
:root.dark .rating-stars .text-warning.far.fa-star,
:root.dark .rating-stars i.text-warning.far.fa-star {
    color: #9ca3af !important;
    text-shadow: none !important;
    filter: none !important;
    box-shadow: none !important;
}
/* Remover todos os efeitos de brilho de todas as estrelas no dark mode e garantir cor amarela */
:root.dark .text-warning.fa-star:not(.far),
:root.dark .text-warning.fa-star-half-alt,
:root.dark i.text-warning.fa-star:not(.far),
:root.dark i.text-warning.fa-star-half-alt {
    color: #fbbf24 !important;
    text-shadow: none !important;
    filter: none !important;
    box-shadow: none !important;
}
:root.dark .text-warning.far.fa-star,
:root.dark i.text-warning.far.fa-star {
    color: #9ca3af !important;
    text-shadow: none !important;
    filter: none !important;
    box-shadow: none !important;
}
.rating-item {
    background: #f8f9fa;
}

/* Escurecer seção de Avaliações e Comentários */
.ratings-comments-body {
    background: rgba(248, 249, 250, 0.95) !important;
}

:root.dark .ratings-comments-body {
    background: rgba(30, 41, 59, 0.95) !important;
    color: var(--color-text) !important;
}

.ratings-form-container {
    background: rgba(255, 255, 255, 0.9) !important;
}

:root.dark .ratings-form-container {
    background: rgba(40, 51, 70, 0.9) !important;
}

:root.dark .rating-item {
    background: rgba(40, 51, 70, 0.8) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: var(--color-text) !important;
}
</style>
{% endblock %}
    