{% extends "base.html" %}

{% block title %}Notificações - MemóriaViva{% endblock %}

{% block content %}
<div class="page-shell">
    <div class="page-header">
        <div class="page-header-main">
            <h1 class="page-header-title">Notificações</h1>
            <p class="page-header-subtitle">Suas notificações e alertas</p>
        </div>
        <div class="page-header-actions">
            <form method="POST" action="{{ url_for('notifications.mark_all_as_read') }}" class="d-inline" id="markAllReadForm">
                <button type="submit" class="btn btn-primary">Marcar Todas como Lidas</button>
            </form>
        </div>
    </div>

    {% if notifications %}
    <div class="card-grid">
        {% for notification in notifications %}
        <div class="card {% if not notification.is_read %}border-primary{% endif %}" data-notification-id="{{ notification.id }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1">
                            {% if not notification.is_read %}
                            <span class="badge bg-primary me-2">Nova</span>
                            {% endif %}
                            {{ notification.title }}
                        </h6>
                        <p class="card-text mb-2">{{ notification.message }}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> {{ notification.created_at|format_datetime('%d/%m/%Y %H:%M') }}
                        </small>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    {% if notification.link %}
                    <a href="{{ notification.link }}" class="btn btn-outline-primary btn-sm">Ver Detalhes</a>
                    {% endif %}
                    {% if not notification.is_read %}
                    <form method="POST"
                          action="{{ url_for('notifications.mark_as_read', notification_id=notification.id) }}"
                          class="d-inline notification-read-form"
                          data-notification-id="{{ notification.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">Marcar como Lida</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card text-center py-5">
        <i class="bi bi-bell-slash" style="font-size: 3rem; color: var(--color-text, #6B7280); opacity: 0.5;"></i>
        <p class="mt-3 mb-0">Nenhuma notificação encontrada.</p>
    </div>
    {% endif %}
</div>

<script>
const markAllForm = document.getElementById('markAllReadForm');
if (markAllForm) {
    markAllForm.addEventListener('submit', function (e) {
        e.preventDefault();
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remover todos os cards de notificação da lista
                    document.querySelectorAll('.card[data-notification-id]').forEach(card => card.remove());
                }
            });
    });
}

// Tratamento individual: ao marcar como lida, remover o card correspondente da lista
document.querySelectorAll('.notification-read-form').forEach(form => {
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const card = this.closest('.card[data-notification-id]');

        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && card) {
                    card.remove();

                    // Se não restarem notificações, mostrar estado vazio
                    if (!document.querySelector('.card[data-notification-id]')) {
                        const container = document.querySelector('.page-shell');
                        if (container) {
                            container.innerHTML = `
                                <div class="card text-center py-5">
                                    <i class="bi bi-bell-slash" style="font-size: 3rem; color: var(--color-text, #6B7280); opacity: 0.5;"></i>
                                    <p class="mt-3 mb-0">Nenhuma notificação encontrada.</p>
                                </div>
                            `;
                        }
                    }
                }
            });
    });
});
</script>
{% endblock %}

